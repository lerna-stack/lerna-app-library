#
# SequenceFactoryWorker が SequenceStore からの応答を受け取ったときにどのように振る舞うかケースを洗い出します
# 書き方: https://github.com/Microsoft/pict/blob/main/doc/pict.md
#
##################################################
# 条件
##################################################

# 返信を受け取る前の isEmpty
isEmpty: TRUE, FALSE

# 返信を受け取る前の isOverflow
isOverflow: TRUE, FALSE

# 受け取った返信
msg: SequenceReserved, ReservationFailed, SequenceReset

# 受け取った返信の maxReservedValue
# ReservationFailed には maxReservedValue がないので NaN を使う
msg.maxReservedValue: > ctx.maxReservedValue, = ctx.maxReservedValue, < ctx.maxReservedValue, NaN

##################################################
# 結果
##################################################

# 返信を受け取った後の SequenceContext の状態

@received.isEmpty: <isEmpty>

# 返信の直後に GenerateSequence を受け取ったときの振る舞い

@採番: する, しない

##################################################
# 条件の制約
##################################################

# msg.maxReservedValue

# msg.maxReservedValue = NaN は ReservationFailed のときだけ
IF [msg] = "ReservationFailed"
THEN [msg.maxReservedValue] = "NaN"
ELSE [msg.maxReservedValue] <> "NaN";

# SequenceStore のコマンドに対する応答順序が前後することはないため、
# msg.maxReservedValue < ctx.maxReservedValue となるメッセージが届くことはない
IF [msg] = "SequenceReserved"
THEN [msg.maxReservedValue] <> "< ctx.maxReservedValue";

# 採番値リセットで ctx.maxReservedValue よりも大きい maxReservedValue が予約されることはない
IF [msg] = "SequenceReset"
THEN [msg.maxReservedValue] <> "> ctx.maxReservedValue";

# オーバフローしているときに、それよりも大きい採番値が予約されることはない
IF [isOverflow] = "TRUE"
THEN [msg.maxReservedValue] <> "> ctx.maxReservedValue";

# isEmpty

# オーバフローしているということは採番値がないことと同義
IF [isOverflow] = "TRUE"
THEN [isEmpty] = "TRUE";

# isOverflow

##################################################
# 結果の条件
##################################################

# @received.isEmpty

# 予約成功
IF [isOverflow] = "FALSE" AND [isEmpty] = "TRUE" AND ([msg] = "SequenceReserved" AND [msg.maxReservedValue] = "> ctx.maxReservedValue")
THEN [@received.isEmpty] = "FALSE";

# 予約未成功
IF [isOverflow] = "FALSE" AND [isEmpty] = "TRUE" AND ([msg] <> "SequenceReserved" OR [msg.maxReservedValue] <> "> ctx.maxReservedValue")
THEN [@received.isEmpty] = "TRUE";

# リセット成功
IF [isOverflow] = "TRUE" AND ([msg] = "SequenceReset" AND [msg.maxReservedValue] = "< ctx.maxReservedValue")
THEN [@received.isEmpty] = "FALSE";

# リセット未成功
IF [isOverflow] = "TRUE" AND ([msg] <> "SequenceReset" OR [msg.maxReservedValue] <> "< ctx.maxReservedValue")
THEN [@received.isEmpty] = "TRUE";

# 採番せずに枯渇することはない
IF [isEmpty] = "FALSE"
THEN [@received.isEmpty] = "FALSE";

# @採番

# 採番値が枯渇していないときだけ採番する
IF [@received.isEmpty] = "TRUE"
THEN [@採番] = "しない"
ELSE [@採番] = "する";

##################### OUTPUT #####################
# 全組み合わせ網羅ケース:
# No  isEmpty  isOverflow  msg                msg.maxReservedValue    @received.isEmpty  @採番
# 1   FALSE    FALSE       ReservationFailed  NaN                     FALSE              する
# 2   FALSE    FALSE       SequenceReserved   = ctx.maxReservedValue  FALSE              する
# 3   FALSE    FALSE       SequenceReserved   > ctx.maxReservedValue  FALSE              する
# 4   FALSE    FALSE       SequenceReset      < ctx.maxReservedValue  FALSE              する
# 5   FALSE    FALSE       SequenceReset      = ctx.maxReservedValue  FALSE              する
# 6   TRUE     FALSE       ReservationFailed  NaN                     TRUE               しない
# 7   TRUE     FALSE       SequenceReserved   = ctx.maxReservedValue  TRUE               しない
# 8   TRUE     FALSE       SequenceReserved   > ctx.maxReservedValue  FALSE              する
# 9   TRUE     FALSE       SequenceReset      < ctx.maxReservedValue  TRUE               しない
# 10  TRUE     FALSE       SequenceReset      = ctx.maxReservedValue  TRUE               しない
# 11  TRUE     TRUE        ReservationFailed  NaN                     TRUE               しない
# 12  TRUE     TRUE        SequenceReserved   = ctx.maxReservedValue  TRUE               しない
# 13  TRUE     TRUE        SequenceReset      < ctx.maxReservedValue  FALSE              する
# 14  TRUE     TRUE        SequenceReset      = ctx.maxReservedValue  TRUE               しない
#
# 条件重複ケース（存在する場合は「結果の条件」の定義に漏れがある）:
# 重複ID  No  isEmpty  isOverflow  msg  msg.maxReservedValue  @received.isEmpty  @採番
#
# オールペア（2因子間網羅）ケース：
# No  isEmpty  isOverflow  msg                msg.maxReservedValue    @received.isEmpty  @採番
# 1   FALSE    FALSE       ReservationFailed  NaN                     FALSE              する
# 2   FALSE    FALSE       SequenceReserved   = ctx.maxReservedValue  FALSE              する
# 3   FALSE    FALSE       SequenceReserved   > ctx.maxReservedValue  FALSE              する
# 4   FALSE    FALSE       SequenceReset      < ctx.maxReservedValue  FALSE              する
# 5   TRUE     FALSE       SequenceReserved   > ctx.maxReservedValue  FALSE              する
# 6   TRUE     FALSE       SequenceReset      < ctx.maxReservedValue  TRUE               しない
# 7   TRUE     FALSE       SequenceReset      = ctx.maxReservedValue  TRUE               しない
# 8   TRUE     TRUE        ReservationFailed  NaN                     TRUE               しない
# 9   TRUE     TRUE        SequenceReserved   = ctx.maxReservedValue  TRUE               しない
# 10  TRUE     TRUE        SequenceReset      < ctx.maxReservedValue  FALSE              する
