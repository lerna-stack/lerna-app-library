#
# SequenceFactoryWorker が SequenceContext の状態にもとづきどのように振る舞うかケースを洗い出します
# 書き方: https://github.com/Microsoft/pict/blob/main/doc/pict.md
#
##################################################
# 条件
##################################################

# 予約済みの採番値の最大値
# - maxReservedValue > maxSequenceValue は仕様上ありえない
#
maxReservedValue: = maxSequenceValue, < maxSequenceValue

# 次に採番予定の値
nextValue: > maxReservedValue, = maxReservedValue, < maxReservedValue

# [採番後] 次に採番予定の値
after_nextValue: <nextValue>

# [採番後] 採番可能なシーケンスの数
# - after_remainAmount > reservationAmount は仕様上ありえない
#
after_remainAmount: = reservationAmount, < reservationAmount

# [採番後] 発行できるシーケンスが少なくなっているかどうか
# reservationFactor を抽象化する
#
after_isStarving: TRUE, FALSE

##################################################
# 結果
##################################################

# 発行できるシーケンスの最大値を超えている
@isOverflow: TRUE, FALSE

# 発行できるシーケンスがない
@isEmpty: TRUE, FALSE

@採番: する, しない

# [採番後] 追加で予約可能なシーケンスの数
# - freeAmount < 0 は仕様上ありえない
#
@after_freeAmount: > 0, = 0

# [採番後] 発行できるシーケンスの最大値を超えている
@after_isOverflow: <@isOverflow>

# [採番後] 発行できるシーケンスがない
@after_isEmpty: <@isEmpty>

@採番値予約: する, しない

@採番値リセット: する, しない

##################################################
# 条件の制約
##################################################

# after_isStarving

# remainAmount = 0 の場合 isStarving は常に TRUE になる
# maxReservedValue < nextValue, maxReservedValue = nextValue の場合に remainAmount = 0 となる
#
IF [after_nextValue] = "> maxReservedValue" OR [after_nextValue] = "= maxReservedValue"
THEN [after_isStarving] = "TRUE";

IF [@after_isEmpty] = "TRUE"
THEN [after_isStarving] = "TRUE";

# after_nextValue

IF [@採番] = "しない"
THEN [after_nextValue] = [nextValue];

IF [@採番] = "する" AND [nextValue] = "< maxReservedValue"
THEN [after_nextValue] = "< maxReservedValue" OR [after_nextValue] = "= maxReservedValue";

IF [@採番] = "する" AND [nextValue] = "= maxReservedValue"
THEN [after_nextValue] = "> maxReservedValue";

##################################################
# 結果の条件
##################################################

# @isOverflow

IF [maxReservedValue] = "= maxSequenceValue" AND [nextValue] = "> maxReservedValue"
THEN [@isOverflow] = "TRUE";

IF [maxReservedValue] = "= maxSequenceValue" AND [nextValue] in { "= maxReservedValue", "< maxReservedValue" }
THEN [@isOverflow] = "FALSE";

IF [maxReservedValue] = "< maxSequenceValue"
THEN [@isOverflow] = "FALSE";

# @isEmpty

IF [nextValue] = "> maxReservedValue"
THEN [@isEmpty] = "TRUE"
ELSE [@isEmpty] = "FALSE";

# @採番
# 採番と、採番値予約/リセット で SequenceContext の状態が評価されるタイミングが異なることに注意してください
# 採番するかどうかは採番前の SequenceContext にもとづき決定しますが、
# 採番値予約/リセットするかどうかは採番後の SequenceContext（nextValue がインクリメントされたもの）にもとづき決定します

IF [@isEmpty] = "TRUE"
THEN [@採番] = "しない"
ELSE [@採番] = "する";

# @after_freeAmount

IF [maxReservedValue] = "< maxSequenceValue" AND [after_remainAmount] = "= reservationAmount"
THEN [@after_freeAmount] = "= 0";

IF [maxReservedValue] = "< maxSequenceValue" AND [after_remainAmount] = "< reservationAmount"
THEN [@after_freeAmount] = "> 0";

IF [maxReservedValue] = "= maxSequenceValue"
THEN [@after_freeAmount] = "= 0";

# @after_isOverflow

IF [@採番] = "しない"
THEN [@after_isOverflow] = [@isOverflow];

IF [@採番] = "する" AND [maxReservedValue] = "= maxSequenceValue" AND [after_nextValue] = "> maxReservedValue"
THEN [@after_isOverflow] = "TRUE";

IF [@採番] = "する" AND [maxReservedValue] = "= maxSequenceValue" AND [after_nextValue] in { "= maxReservedValue", "< maxReservedValue" }
THEN [@after_isOverflow] = "FALSE";

IF [maxReservedValue] = "< maxSequenceValue"
THEN [@after_isOverflow] = "FALSE";

# @after_isEmpty

IF [@採番] = "する" AND [after_nextValue] = "> maxReservedValue"
THEN [@after_isEmpty] = "TRUE"
ELSE [@after_isEmpty] = "FALSE";

# @採番値予約

IF [@after_isOverflow] = "TRUE"
THEN [@採番値予約] = "しない";

IF [@after_isOverflow] = "FALSE" AND [@after_freeAmount] = "> 0" AND [after_isStarving] = "TRUE"
THEN [@採番値予約] = "する";

IF [@after_isOverflow] = "FALSE" AND [@after_freeAmount] = "> 0" AND [@after_isEmpty] = "TRUE"
THEN [@採番値予約] = "する";

IF [@after_isOverflow] = "FALSE" AND [@after_freeAmount] = "= 0"
THEN [@採番値予約] = "しない";

IF [@after_isOverflow] = "FALSE" AND [after_isStarving] = "FALSE" AND [@after_isEmpty] = "FALSE"
THEN [@採番値予約] = "しない";

IF [maxReservedValue] = "= maxSequenceValue" AND [@after_isEmpty] = "TRUE"
THEN [@採番値予約] = "しない";

# @採番値リセット

IF [@after_isOverflow] = "TRUE" AND [@after_isEmpty] = "TRUE"
THEN [@採番値リセット] = "する"
ELSE [@採番値リセット] = "しない";


# ❯ cat sequence_factory_worker.pict | docker run --rm -i ghcr.io/iceomix/pict -o:13 | tee pict.txt
# ❯ cat <(head -n1 pict.txt) <(sort -t $'\t' <(sed '1d' pict.txt)) | awk -v FS='\t' -v OFS='\t' '{ print (NR == 1) ? "No" : NR - 1, $0 }' | column --table -s $'\t' | sed -E 's/^/# /'
#
# -o: オプションで条件数と同じ数を指定することで全網羅パターンを出力できる。（デフォルトではペアワイズ法によりケースが絞られる）
# 参考：
# ペアワイズ法によるテストケース抽出ツール「PICT」を使ってテストケースを85%削減する - Qiita
# https://qiita.com/bremen/items/6eceddc534d87fc797cc
#
# No  maxReservedValue    nextValue           after_nextValue     after_remainAmount   after_isStarving  @isOverflow  @isEmpty  @採番   @after_freeAmount  @after_isOverflow  @after_isEmpty  @採番値予約  @採番値リセット
# 1   < maxSequenceValue  < maxReservedValue  < maxReservedValue  < reservationAmount  FALSE             FALSE        FALSE     する    > 0                FALSE              FALSE           しない       しない
# 2   < maxSequenceValue  < maxReservedValue  < maxReservedValue  < reservationAmount  TRUE              FALSE        FALSE     する    > 0                FALSE              FALSE           する         しない
# 3   < maxSequenceValue  < maxReservedValue  < maxReservedValue  = reservationAmount  FALSE             FALSE        FALSE     する    = 0                FALSE              FALSE           しない       しない
# 4   < maxSequenceValue  < maxReservedValue  < maxReservedValue  = reservationAmount  TRUE              FALSE        FALSE     する    = 0                FALSE              FALSE           しない       しない
# 5   < maxSequenceValue  < maxReservedValue  = maxReservedValue  < reservationAmount  TRUE              FALSE        FALSE     する    > 0                FALSE              FALSE           する         しない
# 6   < maxSequenceValue  < maxReservedValue  = maxReservedValue  = reservationAmount  TRUE              FALSE        FALSE     する    = 0                FALSE              FALSE           しない       しない
# 7   < maxSequenceValue  = maxReservedValue  > maxReservedValue  < reservationAmount  TRUE              FALSE        FALSE     する    > 0                FALSE              TRUE            する         しない
# 8   < maxSequenceValue  = maxReservedValue  > maxReservedValue  = reservationAmount  TRUE              FALSE        FALSE     する    = 0                FALSE              TRUE            しない       しない
# 9   < maxSequenceValue  > maxReservedValue  > maxReservedValue  < reservationAmount  TRUE              FALSE        TRUE      しない  > 0                FALSE              FALSE           する         しない
# 10  < maxSequenceValue  > maxReservedValue  > maxReservedValue  = reservationAmount  TRUE              FALSE        TRUE      しない  = 0                FALSE              FALSE           しない       しない
# 11  = maxSequenceValue  < maxReservedValue  < maxReservedValue  < reservationAmount  FALSE             FALSE        FALSE     する    = 0                FALSE              FALSE           しない       しない
# 12  = maxSequenceValue  < maxReservedValue  < maxReservedValue  < reservationAmount  TRUE              FALSE        FALSE     する    = 0                FALSE              FALSE           しない       しない
# 13  = maxSequenceValue  < maxReservedValue  < maxReservedValue  = reservationAmount  FALSE             FALSE        FALSE     する    = 0                FALSE              FALSE           しない       しない
# 14  = maxSequenceValue  < maxReservedValue  < maxReservedValue  = reservationAmount  TRUE              FALSE        FALSE     する    = 0                FALSE              FALSE           しない       しない
# 15  = maxSequenceValue  < maxReservedValue  = maxReservedValue  < reservationAmount  TRUE              FALSE        FALSE     する    = 0                FALSE              FALSE           しない       しない
# 16  = maxSequenceValue  < maxReservedValue  = maxReservedValue  = reservationAmount  TRUE              FALSE        FALSE     する    = 0                FALSE              FALSE           しない       しない
# 17  = maxSequenceValue  = maxReservedValue  > maxReservedValue  < reservationAmount  TRUE              FALSE        FALSE     する    = 0                TRUE               TRUE            しない       する
# 18  = maxSequenceValue  = maxReservedValue  > maxReservedValue  = reservationAmount  TRUE              FALSE        FALSE     する    = 0                TRUE               TRUE            しない       する
# 19  = maxSequenceValue  > maxReservedValue  > maxReservedValue  < reservationAmount  TRUE              TRUE         TRUE      しない  = 0                TRUE               FALSE           しない       しない
# 20  = maxSequenceValue  > maxReservedValue  > maxReservedValue  = reservationAmount  TRUE              TRUE         TRUE      しない  = 0                TRUE               FALSE           しない       しない
#
# プレフィックス "@" が付いてない条件の組み合わせに重複がある場合、「結果の条件」の定義に漏れがあることがわかる。
#
# ❯ cat pict.txt | cut -f 1,2,3,4,5 | sort | uniq --repeated | wc -l
# 0
#
